<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>HidroAlerta SE - Sistema de Alerta Temprana</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: -apple-system,BlinkMacSystemFont,Segoe UI,sans-serif; background:#0a0e17; color:#e0e6ed; }
.header { background:linear-gradient(135deg,#0d1520,#162032); padding:12px 24px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #1e3a5f; }
.header h1 { font-size:1.3em; color:#4fc3f7; }
.header .status { font-size:0.85em; color:#78909c; }
.main { display:grid; grid-template-columns:1fr 380px; height:calc(100vh - 50px); }
#map { width:100%; height:100%; }
.sidebar { overflow-y:auto; background:#0d1520; border-left:1px solid #1e3a5f; padding:12px; }
.group-title { font-size:0.9em; color:#4fc3f7; margin:12px 0 6px; padding:4px 8px; background:#0a1628; border-radius:4px; border-left:3px solid #4fc3f7; }
.group-title.flash { border-left-color:#ff7043; color:#ff7043; }
.basin-card { background:#121d2e; border-radius:8px; padding:10px; margin-bottom:8px; border:1px solid #1e3a5f; cursor:pointer; transition:border-color 0.2s; }
.basin-card:hover { border-color:#4fc3f7; }
.basin-card .name { font-size:0.9em; font-weight:600; color:#fff; }
.basin-card .meta { font-size:0.75em; color:#78909c; margin-top:2px; }
.basin-card .values { display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; margin-top:6px; }
.val-box { text-align:center; background:#0a1628; border-radius:4px; padding:4px; }
.val-box .num { font-size:1em; font-weight:700; }
.val-box .lbl { font-size:0.65em; color:#78909c; }
.alert-green .num { color:#66bb6a; }
.alert-yellow .num { color:#ffee58; }
.alert-orange .num { color:#ffa726; }
.alert-red .num { color:#ef5350; }
.sub-list { font-size:0.75em; margin-top:6px; padding-top:6px; border-top:1px solid #1e3a5f; }
.sub-item { display:flex; justify-content:space-between; padding:2px 0; color:#90a4ae; }
.sub-item .sub-flow { color:#4fc3f7; }
#hydro-chart { width:100%; height:180px; margin-top:10px; background:#0a1628; border-radius:8px; padding:8px; }
.alerts-panel { margin-top:10px; }
.alert-item { padding:6px 8px; border-radius:4px; margin-bottom:4px; font-size:0.8em; }
.alert-item.red { background:rgba(239,83,80,0.15); border:1px solid #ef5350; color:#ef5350; }
.alert-item.orange { background:rgba(255,167,38,0.15); border:1px solid #ffa726; color:#ffa726; }
.alert-item.yellow { background:rgba(255,238,88,0.15); border:1px solid #ffee58; color:#ffee58; }
</style>
</head>
<body>
<div class="header">
  <h1>HidroAlerta SE - Modelo Semi-Distribuido</h1>
  <div class="status" id="status">Conectando...</div>
</div>
<div class="main">
  <div id="map"></div>
  <div class="sidebar" id="sidebar">
    <canvas id="hydro-chart"></canvas>
    <div class="alerts-panel" id="alerts"></div>
    <div id="basin-cards"></div>
  </div>
</div>
<script>
const map = L.map('map').setView([37.9,-1.2],8);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
  maxZoom:19,attribution:'CartoDB'
}).addTo(map);

let chart = null;
const basinLayers = {};
const subLayers = {};

function getAlertClass(flow, thresholds) {
  if (!thresholds) return 'alert-green';
  if (flow >= thresholds.red) return 'alert-red';
  if (flow >= thresholds.orange) return 'alert-orange';
  if (flow >= thresholds.yellow) return 'alert-yellow';
  return 'alert-green';
}

function getAlertColor(cls) {
  const colors = {'alert-red':'#ef5350','alert-orange':'#ffa726','alert-yellow':'#ffee58','alert-green':'#66bb6a'};
  return colors[cls] || '#66bb6a';
}

function renderBasins(basins) {
  const cards = document.getElementById('basin-cards');
  cards.innerHTML = '';

  // Agrupar por tipo
  const mainBasins = basins.filter(b => b.type === 'main_basin');
  const flashGroups = basins.filter(b => b.type === 'flash_flood_group');

  if (mainBasins.length > 0) {
    cards.innerHTML += '<div class="group-title">CUENCAS PRINCIPALES</div>';
    mainBasins.forEach(b => cards.innerHTML += buildCard(b));
  }
  if (flashGroups.length > 0) {
    cards.innerHTML += '<div class="group-title flash">RAMBLAS Y ARROYOS</div>';
    flashGroups.forEach(b => cards.innerHTML += buildCard(b));
  }

  // Mapa
  Object.values(basinLayers).forEach(l => map.removeLayer(l));
  Object.values(subLayers).forEach(l => map.removeLayer(l));

  basins.forEach(b => {
    if (!b.bounds) return;
    const cls = getAlertClass(b.currentFlow, b.thresholds);
    const color = getAlertColor(cls);
    const rect = L.rectangle([
      [b.bounds.south, b.bounds.west],
      [b.bounds.north, b.bounds.east]
    ], {color, weight:1, fillOpacity:0.08, dashArray:'4'}).addTo(map);
    rect.bindPopup('<b>'+b.name+'</b><br>Q='+(b.currentFlow||0)+' m3/s<br>P='+(b.precipitation||0)+' mm');
    basinLayers[b.id] = rect;

    // Control point marker
    if (b.controlPoint) {
      const marker = L.circleMarker(b.controlPoint, {
        radius: b.type === 'flash_flood_group' ? 4 : 6,
        fillColor: color, color: '#fff', weight:1, fillOpacity:0.9
      }).addTo(map);
      marker.bindTooltip(b.name, {permanent:false});
      basinLayers[b.id + '_pt'] = marker;
    }
  });
}

function buildCard(b) {
  const cls = getAlertClass(b.currentFlow, b.thresholds);
  const subs = b.hydroResult?.subcatchmentResults || [];
  let subHtml = '';
  if (subs.length > 0) {
    subHtml = '<div class="sub-list">';
    subs.forEach(sub => {
      subHtml += '<div class="sub-item"><span>'+sub.subName+'</span>';
      subHtml += '<span class="sub-flow">'+(sub.routedPeak||0)+' m3/s</span></div>';
    });
    subHtml += '</div>';
  }
  return '<div class="basin-card" onclick="selectBasin('"+b.id+"')">' +
    '<div class="name">'+b.name+'</div>' +
    '<div class="meta">'+(b.hydroResult?.method||'-')+' | '+(b.subcatchmentCount||0)+' subcuencas | '+b.area+' km2</div>' +
    '<div class="values">' +
    '<div class="val-box '+cls+'"><div class="num">'+(b.currentFlow||0)+'</div><div class="lbl">m3/s</div></div>' +
    '<div class="val-box"><div class="num" style="color:#4fc3f7">'+(b.precipitation||0)+'</div><div class="lbl">mm</div></div>' +
    '<div class="val-box"><div class="num" style="color:#ce93d8">'+(b.intensity||0)+'</div><div class="lbl">mm/h max</div></div>' +
    '</div>' + subHtml + '</div>';
}

function selectBasin(id) {
  fetch('/api/basins/'+id+'/hydrograph')
    .then(r => r.json())
    .then(data => {
      if (data.hydrograph && data.hydrograph.length > 0) {
        renderHydrograph(data);
      }
    }).catch(() => {});
}

function renderHydrograph(data) {
  const ctx = document.getElementById('hydro-chart').getContext('2d');
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.hydrograph.map(h => h.time.toFixed(1)+'h'),
      datasets: [{
        label: 'Caudal (m3/s)',
        data: data.hydrograph.map(h => h.flow),
        borderColor: '#4fc3f7', backgroundColor: 'rgba(79,195,247,0.1)', fill:true, tension:0.3, pointRadius:0
      }]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      scales: {
        x: { ticks:{color:'#78909c',maxTicksLimit:8}, grid:{color:'#1e3a5f'} },
        y: { ticks:{color:'#78909c'}, grid:{color:'#1e3a5f'} }
      },
      plugins: { legend:{labels:{color:'#e0e6ed'}} }
    }
  });
}

function renderAlerts(alerts) {
  const el = document.getElementById('alerts');
  if (!alerts || alerts.length === 0) { el.innerHTML = ''; return; }
  el.innerHTML = alerts.map(a => 
    '<div class="alert-item "+a.level+"">"+a.message+"</div>"
  ).join('');
}

// WebSocket
function connect() {
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  const ws = new WebSocket(proto + '://' + location.host);

  ws.onopen = () => {
    document.getElementById('status').textContent = 'Conectado';
    document.getElementById('status').style.color = '#66bb6a';
  };

  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    if (msg.type === 'init' || msg.type === 'update') {
      renderBasins(msg.data.basins || []);
      renderAlerts(msg.data.alerts || []);
      if (msg.data.lastUpdate) {
        document.getElementById('status').textContent = 
          'Actualizado: ' + new Date(msg.data.lastUpdate).toLocaleTimeString();
      }
      // Marcar estaciones
      (msg.data.stations || []).forEach(st => {
        if (st.lat && st.lon) {
          L.circleMarker([st.lat, st.lon], {
            radius:2, fillColor:'#90a4ae', color:'#90a4ae', weight:0, fillOpacity:0.5
          }).addTo(map).bindTooltip(st.name || st.id, {permanent:false});
        }
      });
    }
  };

  ws.onclose = () => {
    document.getElementById('status').textContent = 'Desconectado - Reconectando...';
    document.getElementById('status').style.color = '#ef5350';
    setTimeout(connect, 5000);
  };
}
connect();
</script>
</body>
</html>
